<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="./node_modules/bootstrap/dist/css/bootstrap.css" />
    <link rel="stylesheet" href="./styles/styles.css" />
    <title>CookUni</title>
</head>

<body>
    <div id="rooter" class="cover-container w-100 d-flex h-100 p-3 mx-auto flex-column">

				<header class="masthead mb-auto">
            <div class="inner">
                <h3 class="masthead-brand">CookUni</h3>
                <nav id="nav" class="nav nav-masthead justify-content-center">
                </nav>
            </div>
        </header>
        

        <div id="notifications">
            <div id="successBox" class="alert alert-success" role="alert">{Success Message...}</div>
            <div id="loadingBox" class="alert alert-info" role="alert">Loading...</div>
            <div id="errorBox" class="alert alert-danger" role="alert">{Error Message...}</div>
        </div>

        <main role="main" class="inner cover mt-5">
            <h1 class="cover-heading text-center">(Cook)ing (Uni)versity</h1>
            <p class="lead text-center">Food is part art, part organic chemistry.
							Food is nutrition and love. Food can harm. Food can heal. Food is universal ... We all love flavor, sometimes we all need basic. They say that food passes through the stomach, we say that food passes through CookUni...
            </p>
        </main>

				<div id="container"></div>

        <footer class="mastfoot mt-5 text-center text-light">
            <div class="inner">
                <p>Made with &hearts; by <a href="#/home">CookUni</a>.</p>
            </div>
            <i class="fa fa-heart"></i>
        </footer>
    </div>
</body>

<!-- Libraries -->
<script src="./node_modules/jquery/dist/jquery.js"></script>
<script src="./node_modules/bootstrap/dist/js/bootstrap.js"></script>
<!-- <script src="./node_modules/handlebars/dist/handlebars.js"></script> -->
<script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>
<!--My Libraries-->
<script src="./scripts/app.js"></script>

<script id="fnf" type="text/x-handlebars-template"><!-- food not found template -->
	<div id='foodNotFound'>
		<img src="https://t4.ftcdn.net/jpg/00/62/17/31/240_F_62173114_ozantkVtkPgzL0fxssAkTqKX1FHPr0UW.jpg" />
		<h3>Food not found...</h3>
		<p>Seem to be missing recepies? <a href="#share">Share your favorites here</a>.</p>
		<!-- Need help getting started? Read our getting started guide. -->
	</div>
</script>

<script id="recepieCard" type="text/x-handlebars-template">
  <h1 class="text-center">Our Recipes</h1>
  <div id="sharedRecipes">
		{{#each recipe}}
			<div class="container">
				<div class="row">
					<div class="col-lg-12">
						<div class="our-team-main" onmouseenter="moveDiv(this)" onmouseleave="fixDiv(this)">
							<div class="team-front">
								<img src="{{imgURL}}" />
								<h3>{{mealName}}</h3>
								<p>{{category}}</p>
							</div>
							<div class="team-back">
								<div class="back-side-info">
									<h4>Ingredients</h4>
									<ul>
									{{#each ingredient}}
										<li>{{item}}</li>
									{{/each}}
									</ul>
									<a href="#recepie/{{recepieID}}">View the recepie</a>
								</div>
								<img class="foodImage" src="{{foodImageURL}}" />
							</div>
						</div>
					</div>
				</div>
			</div>
		{{/each}}
	</div>
</script>

<script id="navLoggedIn" type="text/x-handlebars-template">
	<a class="nav-link" href="#home">Home</a>
	<a class="nav-link" id="login-welcome" href="#home">Welcome, {{name}}!</a>
	<a class="nav-link" id="share" href="#share">Share recipe</a>
	<a class="nav-link" id="logout" href="#logout">Logout</a>
</script>

<script id="navLoggedOut" type="text/x-handlebars-template">
	<a class="nav-link" href="#home">Home</a>
	<a class="nav-link" id="login-welcome" href="#home">Welcome, Guest!</a>
	<a class="nav-link" id="login" href="#login">Login</a>
	<a class="nav-link" id="register" href="#register">Register</a>
</script>

<script id="recepieInfo" type="text/x-handlebars-template">
	<div class="row form-layout p-5">
		<div class="col-md-12">
			<div class="recepieInfo">
				<div class="detailsFoodImage">
					<img src="{{imgURL}}" alt="">
				</div>
				<div class="infoPack">
					<h3 class="my-3">{{mealName}}</h3>
					<p class="prep-method">{{prepMethod}}</p>
					<p class="description">{{description}}</p>
				</div>
				<div class="actions">
					<a class="btn btn-danger" href="#archive/{{recepieID}}">Archive</a>
					<a class="btn btn-info" href="#edit/{{recepieID}}">Edit</a>
					<a class="btn btn-success" href="#like/{{recepieID}}">{{numLikes}}</a>
				</div>
			</div>
			<div class="detailsIngredients">
				<h3 class="my-3 ingredient">Ingredients</h3>
				<ul>
					{{#each ingredient}}
					<li>{{item}}</li>
					{{/each}}
				</ul>
			</div>
		</div>
	</div>
</script>

<script id="recepieEdit" type="text/x-handlebars-template">
	<form class="text-center p-5 form-layout" action="#" method="POST" id="edit-receipt-form">
		<p class="h4 mb-4">Edit Recipe</p>
	
		<input type="text" id="editMeal" name="meal" class="form-control mb-4" placeholder="Meal Title"
			value="" autofocus="autofocus" onfocus="this.select()">
	
		<input type="text" id="editIngredients" name="ingredients" class="form-control mb-4"
			placeholder="Ingredients" value="">
	
		<textarea type="text" id="editPreparation" name="prepMethod" class="form-control mb-4"
			placeholder="Method of preparation"></textarea>
	
		<textarea type="text" id="editDescription" name="description" class="form-control mb-4"
			placeholder="Description"></textarea>
	
		<input type="text" id="editFoodImageURL" name="foodImageURL" class="form-control mb-4"
			placeholder="Food Image URL..." value="">
	
		<select name="category" id="editCategory" select="">
			<option selected>Select category...</option>
			<option>Vegetables and legumes/beans</option>
			<option>Fruits</option>
			<option>Grain Food</option>
			<option>Milk, cheese, eggs and alternatives</option>
			<option>Lean meats and poultry, fish and alternatives</option>
		</select>
		<button class="btn btn-danger w-25 m-auto my-4 btn-block" type="submit" id="editButton">Edit it</button>
	</form>
</script>

<script id="registerTemplate" type="text/x-handlebars-template">
	<form class="text-center p-5 form-layout" action="#" method="POST">
		<p class="h4 mb-4">Register</p>
		<div class="form-row mb-4">
			<div class="col">
				<input type="text" id="defaultRegisterFormFirstName" class="form-control" name="firstName" placeholder="First name" autofocus="autofocus" onfocus="this.select()">
			</div>
			<div class="col">
				<input type="text" id="defaultRegisterFormLastName" class="form-control" name="lastName" placeholder="Last name">
			</div>
		</div>
		<input type="text" id="defaultRegisterFormUsername" class="form-control mb-4" name="username" placeholder="Username">
		<input type="password" id="defaultRegisterFormPassword" class="form-control" name="password" placeholder="Password">
		<hr>
		<input type="password" id="defaultRegisterRepeatPassword" class="form-control" name="repeatPassword" placeholder="Repeat Password">
		<button class="btn btn-danger my-4 btn-block w-25 m-auto" type="submit" id="registerButton">Register</button>
	</form>
</script>

<script id="loginTemplate" type="text/x-handlebars-template">
	<form class="text-center p-5 form-layout" action="#" method="POST">
		<p class="h4 mb-4">Sign in</p>
		<input type="text" id="loginFormUserName" name="username" class="form-control mb-4" placeholder="Username" autofocus="autofocus" onfocus="this.select()">
		<input type="password" id="loginFormPassword" name="password" class="form-control" placeholder="Password">
		<hr>
		<button class="btn btn-danger w-25 m-auto my-4 btn-block" type="submit" id="loginButton">Sign in</button>
	</form>
	<p>Not already a CookUni user? <a href="#register">Register here</a>.</p>
</script>

<script> function login (){ // and loginClick()
		let src = document.getElementById("loginTemplate").innerHTML;
		let template = Handlebars.compile(src);
		let context = {}; // {{ N/A }}
		let html = template(context);
		render(html);
		let loginButton = document.getElementById("loginButton");
		loginButton.addEventListener( "click", (e) => { e.preventDefault(); loginClick(); } );
	}
	function loginClick (){
		// console.log( "Login button clicked." );
		let userName = document.getElementById("loginFormUserName").value;
		let passWord = document.getElementById("loginFormPassword").value;
		let url = "https://cookuniproject-default-rtdb.firebaseio.com/users.json";
		let headers = {
    	method: 'GET', 
    	headers: {
      	'Content-Type': 'application/json'
    	}
  	};
		let users = {};
		fetch( url, headers )
		.then(function(response){
			// if( response.status == 200 ){
				return response.json();
			// }
		})
		.then(function(data){
			console.log( data );
			users = data;
			// console.log( Object.entries(users) );
			let newUsers = Object.entries(users);
			for( let idx in newUsers ){
				// console.log( idx, newUsers[idx], newUsers[idx][1].userName, newUsers[idx][1].password );
				if( newUsers[idx][1].userName == userName && newUsers[idx][1].password == passWord ){
					// console.log( idx, "matches", newUsers[idx][0] );
					user = newUsers[idx][0];
					userObj = newUsers[idx][1];
					window.location.hash = "#home";
					console.log( "logged in", userObj.firstName, user, JSON.stringify(userObj) );
				}
			}
		});
	}
</script>

<script> function register (){ // and registerClick()
		let src = document.getElementById("registerTemplate").innerHTML;
		let template = Handlebars.compile( src );
		let context = {}; // {{ N/A }}
		let html = template(context);
		render(html);		
		let registerButton = document.getElementById("registerButton");
		registerButton.addEventListener( "click", (e) => { 
												e.preventDefault();
												registerClick();
											});
	}
	function registerClick(){
		// console.log( "Register button clicked." );
		// TODO ( use the login code to find user, and if NOT, register )
		let firstName = document.getElementById("defaultRegisterFormFirstName");
		let lastName = document.getElementById("defaultRegisterFormLastName");
		let userName = document.getElementById("defaultRegisterFormUsername");
		let firstPass = document.getElementById("defaultRegisterFormPassword");
		let secondPass = document.getElementById("defaultRegisterRepeatPassword");
		let url = "https://cookuniproject-default-rtdb.firebaseio.com/users.json";
		let userError = "This username is already taken. Please retry your request with a different username.";
		let passError = "Passwords do not match. Please retry your request with matching passwords.";
		let users = {};
		let valid = true;
		// check parts for required entries ( TODO )
		if( !firstName.value ){
			valid = false;
			firstName.style.borderColor = "red";
		}else{
			firstName.style.borderColor = "green";
		}
		if( !lastName.value ){
			valid = false;
			lastName.style.borderColor = "red";
		}else{
			lastName.style.borderColor = "green";
		}
		if( !userName.value ){
			valid = false;
			userName.style.borderColor = "red";
		}else{
			userName.style.borderColor = "green";
		}
		if( !firstPass.value ){
			valid = false;
			firstPass.style.borderColor = "red";
		}else{
			firstPass.style.borderColor = "green";
		}
		if( !secondPass.value ){
			valid = false;
			secondPass.style.borderColor = "red";
		}else{
			secondPass.style.borderColor = "green";
		}
		if( firstPass.value != secondPass.value ){
			alert( passError );
			return;
		}else{
			fetch( url )
			.then(function(response){
				// if( response.status == 200 ){
					return response.json();
				// }
			})
			.then(function(data){
				// console.log( data );
				// console.log( Object.entries(data) );
				let newUsers = Object.entries(data);
				for( let idx in newUsers ){
					// console.log( idx, newUsers[idx], newUsers[idx][1].userName, newUsers[idx][1].password );
					if( newUsers[idx][1].userName == userName.value && newUsers[idx][1].password == firstPass.value ){
						firstPass.value = "";
						secondPass.value = "";
						alert( userError );
						return;
					}
				}
			});
		}
		let body = {
			userName: userName.value,
			password: firstPass.value,
			firstName: firstName.value,
			lastName: lastName.value
		};
		let headers = {
    	method: 'POST', 
    	headers: {
      	'Content-Type': 'application/json'
    	},
    	body: JSON.stringify(body)
  	};
		console.log( JSON.stringify(body) );
		fetch( url, headers )
		.then(function(response){
          console.log(response);
					return response.json(); }
		).then(function(data){
					console.log(data);
					user = data.name;
					return data; }
		);
	}
</script>

<script> function home (){
		console.log( "I'm home!" );
		if ( !user ){ window.location.hash = "#login"; }
		// load recepies
		let url = "https://cookuniproject-default-rtdb.firebaseio.com/recepies.json";
		fetch( url )
		.then(function(response){
			// console.log(response);
			if( response.status > 250 ){
				// TODO do food not found templates
				let src = document.getElementById("fnf").innerHTML;
				let template = Handlebars.compile(src);
				let context = {}; // {{ N/A }}
				let html = template(context);
				render(html);
				return;
			}
			return response.json(); }
		).then(function(data){
			console.log(data); // recepie ID
			console.log(JSON.stringify(data));
			render( JSON.stringify(data) );
			// manipilate data into a form the template will like 
			// process each id into a card template
			return data; }
		);
		
		// if none, go fnf, return;

		// else render list of recepie cards into container
	}
</script>

<script> function renderNav(){
	if( !user && !userObj ){ // render logged out nav
		// let src = document.getElementById("navLoggedOut").innerHTML;
		// let template = Handlebars.compile(src);
		// let context = {}; // {{ N/A }}
		// let html = template(context);
		document.getElementById("nav").innerHTML = document.getElementById("navLoggedOut").innerHTML;
	}else{ // render logged in nav
		console.log( userObj.firstName );
		let src = document.getElementById("navLoggedIn").innerHTML;
		let template = Handlebars.compile(src);
		let context = { name: userObj.firstName };
		let html = template(context);
		document.getElementById("nav").innerHTML = html;
	}
}</script>

<script> function recepieEdit ( idStr ){ // aka: share recepie AND function sendRecepie()
		if ( !user ){ window.location.hash = "#login"; }
		let src = document.getElementById("recepieEdit").innerHTML;
		let template = Handlebars.compile(src);
		let context = {}; // {{ N/A }}
		let html = template(context);
		render(html);
		let editButton = document.getElementById("editButton");
		editButton.addEventListener( "click", (e) => { e.preventDefault(); sendRecepie(); });
	}
	function sendRecepie(){
		let meal = document.getElementById("editMeal");
		let ingredients = document.getElementById("editIngredients");
		let preparation = document.getElementById("editPreparation");
		let foodImgURL = document.getElementById("editFoodImageURL");
		let description = document.getElementById("editDescription");
		let category = document.getElementById("editCategory");
		let catImgURL = getCatImgURL( category[category.selectedIndex].value ); // string
		let valid = true;
		// validate items, highlight bad in red and stay on page
		// TODO validate better?!
		if( !meal.value ){
			valid = false;
			meal.style.borderColor = "red";
		}else{
			meal.style.borderColor = "green";
		}
		if( !ingredients.value ){
			valid = false;
			ingredients.style.borderColor = "red";
		}else{
			ingredients.style.borderColor = "green";
		}
		if( !preparation.value ){
			valid = false;
			preparation.style.borderColor = "red";
		}else{
			preparation.style.borderColor = "green";
		}
		if( !foodImgURL.value ){
			valid = false;
			foodImgURL.style.borderColor = "red";
		}else{
			foodImgURL.style.borderColor = "green";
		}
		if( !description.value ){
			valid = false;
			description.style.borderColor = "red";
		}else{
			description.style.borderColor = "green";
		}
		if( idx == 0 ){
			valid = false;
			category.style.borderColor = "red";
		}else{
			category.style.borderColor = "green";
		}
		if( !valid ){
			return;
		}
		// construct data item for recepie body
		let body = {
			meal: meal.value,
      ingredients: ingredients.value,
      prepMethod: preparation.value,
			description: description.value,
			foodImageURL: foodImgURL.value,
			category: category[category.selectedIndex].value,
			likesCounter: 0,
			categoryImageURL: catImgURL,
			creator: user
    };
		let url = "https://cookuniproject-default-rtdb.firebaseio.com/recepies.json";
		let headers = {
    	method: 'POST', 
    	headers: {
      	'Content-Type': 'application/json'
    	},
    	body: JSON.stringify(body)
  	};
		console.log( JSON.stringify(body) );
		fetch( url, headers )
		.then(function(response){
			// console.log(response);
			return response.json(); }
		).then(function(data){
			console.log(data.name); // recepie ID
			// add data.name to recepie data as "recepieID" (post)
			// user = data.name;
			return data; }
		);
	}
</script>

<script> function recepieInfo ( idStr ){
		if ( !user ){ window.location.hash = "#login"; }
		let url = 'https://cookuniproject-default-rtdb.firebaseio.com/recepies/${idStr}.json';
	}
</script>

<script> function listen(){
		let current = getCurrent();
		// console.log( window.location.hash );
		if( current !== hashRoute ){ // user request page change || current !== ""
			// console.log( window.location.hash );
			hashRoute = current;
			if( hashRoute == "#home" ){ // of a user
				renderNav();
				home();
			}else if( hashRoute == "#register" ){
				renderNav();
				console.log( "Run register()" );
				// window.location.hash = "#register";
				register();
			}else if( hashRoute == "#logout" ){
				logout();
				login();
			}else if( hashRoute.includes("recepie") ){
				console.log( "Run recepieInfo()" );
				let [ i, idStr ] = hashRoute.split("/");
				recepieInfo( idStr );
			}else if( hashRoute == "#edit" || hashRoute == "#share" ){
				console.log( "Run recepieEdit()" );
				recepieEdit();
			}else if( !user || window.location.hash == "" ){
				renderNav();
				console.log( "Run login()" );
				// window.location.hash = "#login";
				login();
			}
		}
		setTimeout( listen, 200 );
	}
	listen();
</script>
</html>