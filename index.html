<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="./node_modules/bootstrap/dist/css/bootstrap.css" />
    <link rel="stylesheet" href="./styles/styles.css" />
    <title>CookUni</title>
</head>

<body>
    <div id="rooter" class="cover-container w-100 d-flex h-100 p-3 mx-auto flex-column">

        <header class="masthead mb-auto">
            <div class="inner">
                <h3 class="masthead-brand">CookUni</h3>
                <nav class="nav nav-masthead justify-content-center">
                    <a class="nav-link" href="#home">Home</a>
                    <a class="nav-link" id="login-welcome" href="#">Welcome, {{name}}!</a>
                    <a class="nav-link" id="share" href="#">Share recipe</a>
                    <a class="nav-link" id="logout" href="#">Logout</a>
                    <a class="nav-link" id="login" href="#">Login</a>
                    <a class="nav-link" id="register" href="#">Register</a>
                </nav>
            </div>
        </header>

        <div id="notifications">
            <div id="successBox" class="alert alert-success" role="alert">{Success Message...}</div>
            <div id="loadingBox" class="alert alert-info" role="alert">Loading...</div>
            <div id="errorBox" class="alert alert-danger" role="alert">{Error Message...}</div>
        </div>

        <main role="main" class="inner cover mt-5">
            <h1 class="cover-heading text-center">(Cook)ing (Uni)versity</h1>
            <p class="lead text-center">Food is part art, part organic chemistry. Food is nutrition and love. Food can harm. Food can heal. Food is universal ... We all love flavor, sometimes we all need basic.
                <!-- They say that food passes through the stomach, we say that food passes through CookUni... -->
            </p>
        </main>

				<div id="container"></div>

        <footer class="mastfoot mt-5 text-center text-light">
            <div class="inner">
                <p>Made with &hearts; by <a href="#/home">CookUni</a>.</p>
            </div>
            <i class="fa fa-heart"></i>
        </footer>
    </div>
</body>

<!-- Libraries -->
<script src="./node_modules/jquery/dist/jquery.js"></script>
<script src="./node_modules/bootstrap/dist/js/bootstrap.js"></script>
<!-- <script src="./node_modules/handlebars/dist/handlebars.js"></script> -->
<!-- <script src="./node_modules/sammy/lib/sammy.js"></script> -->
<!-- <script src="./node_modules/sammy/lib/plugins/sammy.handlebars.js"></script> -->
<script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>
<!--My Libraries-->
<!-- <script src="./scripts/css.js"></script> -->
<script src="./scripts/app.js"></script>

<script id="fnf" type="text/x-handlebars-template"> // food not found template
	<div id='foodNotFound'>
		<img src="https://t4.ftcdn.net/jpg/00/62/17/31/240_F_62173114_ozantkVtkPgzL0fxssAkTqKX1FHPr0UW.jpg" />
		<h3>Food not found...</h3>
	</div>
</script>

<script id="recepieCard" type="text/x-handlebars-template">
  <h1 class="text-center">Our Recipes</h1>
  <div id="sharedRecipes">
		{{#each recipe}}
			<div class="container">
				<div class="row">
					<div class="col-lg-12">
						<div class="our-team-main" onmouseenter="moveDiv(this)" onmouseleave="fixDiv(this)">
							<div class="team-front">
								<img src="{{imgURL}}" />
								<h3>{{mealName}}</h3>
								<p>{{category}}</p>
							</div>
							<div class="team-back">
								<div class="back-side-info">
									<h4>Ingredients</h4>
									<ul>
									{{#each ingredient}}
										<li>{{item}}</li>
									{{/each}}
									</ul>
									<a href="#recepie/{{recepieID}}">View the recepie</a>
								</div>
								<img class="foodImage" src="https://t3.ftcdn.net/jpg/00/25/90/48/240_F_25904887_fhZJ692ukng3vQxzHldvuN981OiYVlJ1.jpg" />
							</div>
						</div>
					</div>
				</div>
			</div>
		{{/each}}
	</div>
</script>

<script id="recepieInfo" type="text/x-handlebars-template">
	<div class="row form-layout p-5">
		<div class="col-md-12">
			<div class="recepieInfo">
				<div class="detailsFoodImage">
					<img src="{{imgURL}}" alt="">
				</div>
				<div class="infoPack">
					<h3 class="my-3">{{mealName}}</h3>
					<p class="prep-method">{{prepMethod}}</p>
					<p class="description">{{description}}</p>
				</div>
				<div class="actions">
					<a class="btn btn-danger" href="#archive/{{recepieID}}">Archive</a>
					<a class="btn btn-info" href="#edit/{{recepieID}}">Edit</a>
					<a class="btn btn-success" href="#like/{{recepieID}}">{{numLikes}}</a>
				</div>
			</div>
			<div class="detailsIngredients">
				<h3 class="my-3 ingredient">Ingredients</h3>
				<ul>
					{{#each ingredient}}
					<li>{{item}}</li>
					{{/each}}
				</ul>
			</div>
		</div>
	</div>
</script>

<script id="recepieEdit" type="text/x-handlebars-template">
	<form class="text-center p-5 form-layout" action="#" method="POST" id="edit-receipt-form">
		<p class="h4 mb-4">Edit Recipe</p>
	
		<input type="text" id="defaultRecepieEditMeal" name="meal" class="form-control mb-4" placeholder="Meal"
			value="">
	
		<input type="text" id="defaultRecepieEditIngredients" name="ingredients" class="form-control mb-4"
			placeholder="Ingredients" value="">
	
		<textarea type="text" id="defaultRecepieEditMethodOfPreparation" name="prepMethod" class="form-control mb-4"
			placeholder="Method of preparation"></textarea>
	
		<textarea type="text" id="defaultRecepieEditDescription" name="description" class="form-control mb-4"
			placeholder="Description"></textarea>
	
		<input type="text" id="defaultRecepieEditFoodImageURL" name="foodImageURL" class="form-control mb-4"
			placeholder="Food Image URL..." value="">
	
		<select name="category" select="">
			<option selected>Select category...</option>
			<option>Vegetables and legumes/beans</option>
			<option>Fruits</option>
			<option>Grain Food</option>
			<option>Milk, cheese, eggs and alternatives</option>
			<option>Lean meats and poultry, fish and alternatives</option>
		</select>
		<button class="btn btn-danger w-25 m-auto my-4 btn-block" type="submit">Edit it</button>
	</form>
</script>

<script id="registerTemplate" type="text/x-handlebars-template">
	<form class="text-center p-5 form-layout" action="#" method="POST">
		<p class="h4 mb-4">Register</p>
		<div class="form-row mb-4">
			<div class="col">
				<input type="text" id="defaultRegisterFormFirstName" class="form-control" name="firstName"
					placeholder="First name">
			</div>
			<div class="col">
				<input type="text" id="defaultRegisterFormLastName" class="form-control" name="lastName"
					placeholder="Last name">
			</div>
		</div>

		<input type="text" id="defaultRegisterFormUsername" class="form-control mb-4" name="username"
			placeholder="Username">
		<input type="password" id="defaultRegisterFormPassword" class="form-control" name="password"
			placeholder="Password">
		<hr>
		<input type="password" id="defaultRegisterRepeatPassword" class="form-control" name="repeatPassword"
			placeholder="Repeat Password">
		<button class="btn btn-danger my-4 btn-block w-25 m-auto" type="submit" id="registerButton">Register</button>
	</form>
</script>

<script id="loginTemplate" type="text/x-handlebars-template">
	<form class="text-center p-5 form-layout" action="#" method="POST">
		<p class="h4 mb-4">Sign in</p>
		<input type="text" id="loginFormUserName" name="username" class="form-control mb-4"
			placeholder="Username">
		<input type="password" id="loginFormPassword" name="password" class="form-control"
			placeholder="Password">
		<hr>
		<button class="btn btn-danger w-25 m-auto my-4 btn-block" type="submit" id="loginButton">Sign in</button>
	</form>
	<p>Not already a CookUni user? <a href="#register">Register here</a>.</p>
</script>

<script> // data(s)
	let hashRoute = undefined;
	let user = undefined;
</script>

<script> // misc functions
	function render( html ){
		document.getElementById("container").innerHTML = html;
	}
	function getCurrent(){
		return window.location.hash;
	}
</script>

<script> function login (){ // and loginClick()
		let src = document.getElementById("loginTemplate").innerHTML;
		let template = Handlebars.compile(src);
		let context = {}; // {{ N/A }}
		let html = template(context);
		// console.log( "login says =>", src, "->", html );
		render(html);
		let loginButton = document.getElementById("loginButton");
		loginButton.addEventListener( "click", (e) => { e.preventDefault(); loginClick(); } );
	}
	function loginClick (){
		// console.log( "Login button clicked." );
		let userName = document.getElementById("loginFormUserName").value;
		let passWord = document.getElementById("loginFormPassword").value;
		let url = "https://cookuniproject-default-rtdb.firebaseio.com/users.json";
		let headers = {
    	method: 'GET', 
    	headers: {
      	'Content-Type': 'application/json'
    	}
  	};
		let users = {};
		fetch( url, headers )
		.then(function(response){
          // console.log(response);
					return response.json()
		})
		.then(function(data){
			console.log( data );
			users = data;
			// console.log( Object.entries(users) );
			let newUsers = Object.entries(users);
			for( let idx in newUsers ){
				// console.log( idx, newUsers[idx], newUsers[idx][1].userName, newUsers[idx][1].password );
				if( newUsers[idx][1].userName == userName && newUsers[idx][1].password == passWord ){
					// console.log( idx, "matches", newUsers[idx][0] );
					user = newUsers[idx][0];
					window.location.hash = "#home";
				}
			}
		});
	}
</script>

<script> function register (){ // and registerClick()
		let src = document.getElementById("registerTemplate").innerHTML;
		let template = Handlebars.compile( src );
		let context = {}; // {{ N/A }}
		let html = template(context);
		render(html);		
		let registerButton = document.getElementById("registerButton");
		registerButton.addEventListener( "click", (e) => { 
												e.preventDefault();
												registerClick();
											});
	}
	async function registerClick(){
		console.log( "Register button clicked." );
		let firstName = document.getElementById("defaultRegisterFormFirstName").value;
		let lastName = document.getElementById("defaultRegisterFormLastName").value;
		let userName = document.getElementById("defaultRegisterFormUsername").value;
		let firstPass = document.getElementById("defaultRegisterFormPassword").value;
		let secondPass = document.getElementById("defaultRegisterRepeatPassword").value;
		// check parts for required entries ( TODO )
		// console.log( firstName, lastName, userName, firstPass );
		if( firstPass && firstPass == secondPass ){
			if( firstName && lastName && userName ){
				// build object to send with make user post request
				body = {
					userName,
					password: firstPass,
					firstName,
					lastName
				};
			}
		}
		// let body = {
		// 	userName,
		// 	password: firstPass,
		// 	firstName,
		// 	lastName
		// };
		let url = "https://cookuniproject-default-rtdb.firebaseio.com/users.json";
		let headers = {
    	method: 'POST', 
    	headers: {
      	'Content-Type': 'application/json'
    	},
    	body: JSON.stringify(body)
  	};
		console.log( JSON.stringify(body) );
		fetch( url, headers )
		.then(function(response){
          console.log(response);
					return response.json(); }
		).then(function(data){
					console.log(data);
					user = data.name;
					return data; }
		);
		console.log( "after fetch" );
		console.log( user );
		// user = await response;
		// console.log(response);
		// console.log( url, headers, body );
	}
</script>

<script> function recepieEdit ( idStr ){
		// get ID from hashRoute
		let src = document.getElementById("recepieEdit").innerHTML;
		let template = Handlebars.compile(src);
		let context = {}; // {{ N/A }}
		let html = template(context);
		render(html);		
	}
</script>

<script> function recepieInfo ( hashRoute ){
		
	}
</script>

<script> function home (){
		console.log( "I'm home!" );
		if ( !user ){ window.location.hash = "#login"; }

		// load recepies
		// if none, go fnf, 
		// else render list of recepie cards
	}
</script>


<script> function listen(){
		let current = getCurrent();
		// console.log( window.location.hash );
		if( current !== hashRoute ){ // user request page change || current !== ""
			// console.log( window.location.hash );
			hashRoute = current;
			if( hashRoute == "#home" ){ // of a user
				console.log( "Run home()" );
				home();
			}else if( hashRoute == "#register" ){
				console.log( "Run register()" );
				// window.location.hash = "#register";
				register();
			}else if( hashRoute.includes("recepie") ){
				console.log( "Run recepieInfo()" );
				let [ i, idStr ] = hashRoute.split("/");
				recepieInfo( idStr );
			}else if( hashRoute.includes("edit") ){
				console.log( "Run recepieEdit()" );
				let [ i, idStr ] = hashRoute.split("/");
				recepieEdit( idStr );
			}else if( !user || window.location.hash == "" ){
				console.log( "Run login()" );
				// window.location.hash = "#login";
				login();
			}
		}
		setTimeout( listen, 200 );
	}
	listen();
</script>
</html>